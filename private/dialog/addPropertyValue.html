<div class="modal hide" id="{dlgAddPropertyValue}">
    <div class="modal-header">
        <a class="close" data-dismiss="modal">×</a>
        <h3>标题</h3>
    </div>
    <div class="modal-body">
        <div class="hide alert alert-error">
            <strong>出错啦！</strong>
            <ul class="error-list">
            </ul>
        </div>


        <div class="accordion" id="accordion2">
            
            <!-- Concept -->
            <div class="accordion-group hide" id='accordionConcept'>
                <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseConcept">
                    添加Concept作为属性值
                </a>
                </div>
                <div id="collapseConcept" class="accordion-body collapse" style="height: 0px;">
                    <div class="accordion-inner">
                        <label for="{txtFn}">Concept名称</label>
                        <input id="{txtFn}" type="text" class="span3" placeholder="请输入关键字后等待搜索..." />
                        <input id="{txtFn}_id" type="hidden" />
                    </div>
                </div>
            </div>

            <!-- 文本 -->
            <div class="accordion-group hide" id='accordionLiteral'>
                <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseLiteral">
                    添加文本作为属性值
                </a>
                </div>
                <div id="collapseLiteral" class="accordion-body collapse" style="height: 0px;">
                <div class="accordion-inner">
                    <label for="{txtValue}">属性值</label>
                    <input id="{txtValue}" type="text" class="span3" placeholder="输入文本作为属性值..." />
                </div>
                </div>
            </div>

            <!-- 长文本Text -->
            <div class="accordion-group hide" id='accordionText' >
                <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseText">
                    添加长文本作为属性值
                </a>
                </div>
                <div id="collapseText" class="accordion-body collapse" style="height: 0px;">
                <div class="accordion-inner">
                    <label>标题
                        <input id="{tbTitle}" type="text" class="span3" placeholder="输入标题..." />
                    </label>
                    <label for="{txtContent}">文本内容</label>
                    <textarea rows="10" id="{txtContent}" class="span3" placeholder="输入文本作为内容..." />
                </div>
                </div>
            </div>


            <!-- 图像 -->
            <div class="accordion-group hide" id='accordionImage'>
                <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseImage">
                    上传图片至第三方作为属性值(暂不可用)
                </a>
                </div>
                <div id="collapseImage" class="accordion-body collapse" style="height: 0px;">
                    <div class="accordion-inner">
                        <input id="txtImage" type="file" />
                    </div>
                </div>
            </div>

        </div>

        <label class="checkbox">
            <input type="checkbox" userId="" id='{cbOnlyMe}' disabled="disabled" /><i class="icon-lock" />仅我可见
        </label>
    </div>
    <div class="modal-footer">
        
        <a href="#" class="btn" data-dismiss="modal">取消</a>
        <button class="btn btn-primary" onclick="addPropertyValue34532532453245325();">确定</button>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function () {
        $("#{dlgAddPropertyValue}").modal({
            backdrop: false,
            keyboard: false,
            show: false
        });

        

        initConceptSearch($('#{txtFn}'), $('#{txtFn}_id'));

        // 获取当前用户信息,并激活"仅我可见"按钮.
        Nagu.MM.getMe().done(function (me) {
            $('#{cbOnlyMe}').removeAttr('disabled').attr('userId', me.Id);
        });

        var dialog = $('#{dlgAddPropertyValue}');

        // 对话框打开时的处理事件
        dialog.on('show', function (eventData) {
            // 由于show事件会在对话框内多个控件被触发
            // 所以此处需要判断触发事件的控件：
            if (eventData.target.id != '{dlgAddPropertyValue}') return;

            // 显示对话框之前，初始化对话框中的各个元素：
            dialog.find('.accordion-group').hide();

            var subjectId = $('#{dlgAddPropertyValue}').attr('predicateId');
            // 根据rdf:range判断显示哪些内容：
            Nagu.CM.getPropertyValues(subjectId, Nagu.Concepts.RdfRange).done(function (fss) {
                if (fss.length == 0) {
                    // 未指定时，显示最基本的两种：
                    $('#accordionConcept').show();
                    $('#accordionLiteral').show();
                } else {
                    $.each(fss, function (i, rangeFs) {
                        switch (rangeFs.Object.ConceptId) {
                            case Nagu.Concepts.NaguImage:
                                $('#accordionImage').show();
                                break;
                            case Nagu.Concepts.NaguConcept:
                                $('#accordionConcept').show();
                                break;
                            case Nagu.Concepts.Literal:
                                $('#accordionLiteral').show();
                                break;
                            case Nagu.Concepts.Article:
                                $('#accordionText').show();
                                break;
                            default:
                                alert('unknown range type: ' + rangeFs.Object.ConceptId);
                        }
                    });
                }
            });
        });
    });
    
    

    function addPropertyValue34532532453245325() {
        var onPropertyValueAdded = null;
        var subject = $('#{dlgAddPropertyValue}').attr('subjectId');
        var stype = $('#{dlgAddPropertyValue}').attr('stype');
        var predicateId = $('#{dlgAddPropertyValue}').attr('predicateId');

        var appId = $('#{cbOnlyMe}').attr('checked') === undefined ? "" : $('#{cbOnlyMe}').attr('userId');

        var ulError = $("#{dlgAddPropertyValue} ul.error-list").empty();

        var cm = new ConceptManager();
        // 如果属性值是Concept：
        if ($('#collapseConcept').hasClass('in')) {
            var fn = $('#{txtFn}').val();
            var conceptId = $('#{txtFn}_id').val();
            if (fn == "") {
                ulError.append(newLi().append("请输入关键字并选择Concept"));
                $('#{dlgAddPropertyValue} .alert-error').show();
                return;
            }
            cm.addConceptPropertyValue(subject, stype, predicateId, fn, conceptId, { appId: appId }).done(function (fs) {
                $('#{txtFn}').val('');
                $('#{txtFn}_id').val('');
                $('#{dlgAddPropertyValue}').modal('hide');
                AddPropertyValueDialog.added(fs);
            });
        // 如果属性值是第三方上传图片:
        } else if ($('#collapseImage').hasClass('in')) {
            uploadTest($('#txtImage'));
            var mm = new MemberManager();
            mm.check().done(function (status) {
            });
        } else if ($('#collapseText').hasClass('in')){
            AddPropertyValueDialog.AddTextValue({
                dialog: $('#{dlgAddPropertyValue}'),
                subjectId: subject,
                predicateId: predicateId,
                tbTitle: $('#{tbTitle}'),
                txtContent: $('#{txtContent}'),
                appId: appId
            });
        }else { // 属性值是文本：
            AddPropertyValueDialog.AddLiteralValue({
                dialog: $('#{dlgAddPropertyValue}'),
                subjectId: subject,
                predicateId: predicateId,
                tbValue: $('#{txtValue}'),
                appId: appId
            });
        }
    }
</script>