<div class="modal hide" id="{dlgAddPropertyValue}">
    <div class="modal-header">
        <a class="close" data-dismiss="modal">×</a>
        <h3>标题</h3>
    </div>
    <div class="modal-body">
        <div class="hide alert alert-error">
            <strong>出错啦！</strong>
            <ul class="error-list">
            </ul>
        </div>


        <div class="accordion" id="accordion2">
            
            <!-- Concept -->
            <div class="accordion-group hide" id='{accordionConcept}'>
                <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseConcept">
                    添加Concept作为属性值
                </a>
                </div>
                <div id="collapseConcept" class="accordion-body collapse" style="height: 0px;">
                    <div class="accordion-inner">
                        <div class="form-horizontal">
                            <div class="control-group">
                            <label for="{txtFn}"  class="control-label">Concept名称</label>
                            <div class="controls">
                                <input id="{txtFn}" type="text" onkeypress="if(event.keyCode === 13){searchForAddValue_0426();}" placeholder="请输入关键字后等待搜索..." />
                                <button onclick="searchForAddValue_0426();" class="btn btn-primary">搜索</button>
                            </div>
                            </div>
                        </div>
                        <h4 class='hide'>请从以下搜索结果中选择：</h4>
                        <ul class="nav nav-pills"></ul>
                        <button id='{btnNew}' class='hide btn btn-primary' onclick='newAndAddPropertyValue_0426()'>去创建一个>></button>
                    </div>
                </div>
            </div>

            <!-- 文本 -->
            <div class="accordion-group hide" id='accordionLiteral'>
                <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseLiteral">
                    添加文本作为属性值
                </a>
                </div>
                <div id="collapseLiteral" class="accordion-body collapse" style="height: 0px;">
                <div class="accordion-inner">
                    <label for="{txtValue}">属性值</label>
                    <input id="{txtValue}" type="text" class="span3" placeholder="输入文本作为属性值..." />
                </div>
                </div>
            </div>

            <!-- 长文本Text -->
            <div class="accordion-group hide" id='accordionText' >
                <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseText">
                    添加长文本作为属性值
                </a>
                </div>
                <div id="collapseText" class="accordion-body collapse" style="height: 0px;">
                <div class="accordion-inner">
                    <label>标题
                        <input id="{tbTitle}" type="text" class="span3" placeholder="输入标题..." />
                    </label>
                    <label for="{txtContent}">文本内容</label>
                    <textarea rows="10" id="{txtContent}" class="span3" placeholder="输入文本作为内容..." />
                </div>
                </div>
            </div>


            <!-- 图像 -->
            <div class="accordion-group hide" id='accordionImage'>
                <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseImage">
                    上传图片至第三方作为属性值(暂不可用)
                </a>
                </div>
                <div id="collapseImage" class="accordion-body collapse" style="height: 0px;">
                    <div class="accordion-inner">
                        <input id="txtImage" type="file" />
                    </div>
                </div>
            </div>

        </div>

        <label class="checkbox">
            <input type="checkbox" userId="" id='{cbOnlyMe}' disabled="disabled" /><i class="icon-lock" />仅我可见
        </label>
    </div>
    <div class="modal-footer">
        
        <a href="#" class="btn" data-dismiss="modal">取消</a>
        <button class="btn btn-primary" onclick="addPropertyValue34532532453245325();">确定</button>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function () {
        $("#{dlgAddPropertyValue}").modal({
            backdrop: false,
            keyboard: false,
            show: false
        });

        // 获取当前用户信息,并激活"仅我可见"按钮.
        Nagu.MM.getMe().done(function (me) {
            $('#{cbOnlyMe}').removeAttr('disabled').attr('userId', me.Id);
        });

        var dialog = $('#{dlgAddPropertyValue}');

        // 对话框打开时的处理事件
        dialog.on('show', function (eventData) {
            // 由于show事件会在对话框内多个控件被触发
            // 所以此处需要判断触发事件的控件：
            if (eventData.target.id != '{dlgAddPropertyValue}') return;

            // 显示对话框之前，初始化对话框中的各个元素：
            dialog.find('.accordion-group').hide();

            var subjectId = $('#{dlgAddPropertyValue}').attr('predicateId');
            // 根据rdf:range判断显示哪些内容：
            Nagu.CM.getPropertyValues(subjectId, Nagu.Concepts.RdfRange).done(function (fss) {
                if (fss.length == 0) {
                    // 未指定时，显示最基本的两种：
                    $('#{accordionConcept}').show();
                    $('#accordionLiteral').show();
                } else {
                    $.each(fss, function (i, rangeFs) {
                        switch (rangeFs.Object.ConceptId) {
                            case Nagu.Concepts.NaguImage:
                                $('#accordionImage').show();
                                break;
                            case Nagu.Concepts.NaguConcept:
                                $('#{accordionConcept}').show();
                                break;
                            case Nagu.Concepts.Literal:
                                $('#accordionLiteral').show();
                                break;
                            case Nagu.Concepts.Article:
                                $('#accordionText').show();
                                break;
                            default:
                                alert('unknown range type: ' + rangeFs.Object.ConceptId);
                        }
                    });
                }
            });
        });
    });


    function searchForAddValue_0426() {
        var dialog = $('#{dlgAddPropertyValue}');
        var ulResult = dialog.find('ul');

        // 进入“等待搜索结果”状态
        dialog.find('h4').show();
        var tempLi = newLi().append(newImg('/Content/Images/loading-128.gif'));
        ulResult.empty().append(tempLi);

        // 开始搜索
        Nagu.CM.search($('#{txtFn}').val()).done(function (cs) {
            if (cs.length == 0) {
                ulResult.empty().append(newLi().append('没有找到任何数据'));
                $('#{btnNew}').show();
                return;
            }
            ulResult.conceptList(cs, {
                clearBefore: true,
                pageSize: 10,
                renderItem: function (concept, li) {
                    li.appendConcept(concept.ConceptId);
                    li.find('a').click(function () {
                        var conceptId = $(this).attr('conceptId');
                        var subjectId = dialog.attr('subjectId');
                        var predicateId = dialog.attr('predicateId');
                        var appId = $('#{cbOnlyMe}').attr('checked') === undefined ? "" : $('#{cbOnlyMe}').attr('userId');

                        AddPropertyValueDialog.AddConceptValue(subjectId, predicateId, conceptId, {
                            appId: appId
                        }).done(function () {
                            $('#{dlgAddPropertyValue}').modal('hide');
                        });

                    });
                }
            });
        });
    }

    function newAndAddPropertyValue_0426() {
        var dialog = $('#{dlgAddPropertyValue}');      
        var fn = $('#{txtFn}').val();
        var fnId = 'tbName' + randomInt();
        var dlgCreateConcept = new CreateConceptDialog({
            fnId: fnId,
            autoInit: false,
            onAdded: function (concept) {
                          
                var subjectId = dialog.attr('subjectId');
                var predicateId = dialog.attr('predicateId');
                var appId = $('#{cbOnlyMe}').attr('checked') === undefined ? "" : $('#{cbOnlyMe}').attr('userId');

                AddPropertyValueDialog.AddConceptValue(subjectId, predicateId, concept.ConceptId, {
                    appId: appId
                });
            }
        });
        dlgCreateConcept.init().done(function () {
            $('#' + fnId).val(fn);
            dialog.modal('hide');
            dlgCreateConcept.toggle();
        });
    }
    

    function addPropertyValue34532532453245325() {
        var onPropertyValueAdded = null;
        var subject = $('#{dlgAddPropertyValue}').attr('subjectId');
        var stype = $('#{dlgAddPropertyValue}').attr('stype');
        var predicateId = $('#{dlgAddPropertyValue}').attr('predicateId');

        var appId = $('#{cbOnlyMe}').attr('checked') === undefined ? "" : $('#{cbOnlyMe}').attr('userId');

        var ulError = $("#{dlgAddPropertyValue} ul.error-list").empty();

        var cm = new ConceptManager();
        // 如果属性值是Concept：
//        if ($('#collapseConcept').hasClass('in')) {
//            var fn = $('#{txtFn}').val();
//            var conceptId = $('#{txtFn}_id').val();
//            if (fn == "") {
//                ulError.append(newLi().append("请输入关键字并选择Concept"));
//                $('#{dlgAddPropertyValue} .alert-error').show();
//                return;
//            }
//            cm.addConceptPropertyValue(subject, stype, predicateId, fn, conceptId, { appId: appId }).done(function (fs) {
//                $('#{txtFn}').val('');
//                $('#{txtFn}_id').val('');
//                $('#{dlgAddPropertyValue}').modal('hide');
//                AddPropertyValueDialog.added(fs);
//            });
        // 如果属性值是第三方上传图片:
        /*} else */if ($('#collapseImage').hasClass('in')) {
            uploadTest($('#txtImage'));
            var mm = new MemberManager();
            mm.check().done(function (status) {
            });
        } else if ($('#collapseText').hasClass('in')){
            AddPropertyValueDialog.AddTextValue({
                dialog: $('#{dlgAddPropertyValue}'),
                subjectId: subject,
                predicateId: predicateId,
                tbTitle: $('#{tbTitle}'),
                txtContent: $('#{txtContent}'),
                appId: appId
            });
        }else { // 属性值是文本：
            AddPropertyValueDialog.AddLiteralValue({
                dialog: $('#{dlgAddPropertyValue}'),
                subjectId: subject,
                predicateId: predicateId,
                tbValue: $('#{txtValue}'),
                appId: appId
            });
        }
    }
</script>